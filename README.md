# Tales Of Shadowland MMO Server 5

This is a multiplayer server based on .NET 8, which automatically generates RPC communication packages and .cpp files for use with Unreal Engine, supporting both C++ and Blueprints. Follow the steps below to set up and start the project.

## Prerequisites

- **Windows 10 or higher**
- **Unreal Engine 5.5+ (recommended)**
- **.NET SDK 8.0 or higher**
- **Visual Studio 2022** 
- Windows **Developer Mode** (to create symlinks)

**Dependencies:** All NuGet packages are automatically installed via `dotnet restore` including Newtonsoft.Json, Spectre.Console, BouncyCastle.Cryptography, FsCheck, and SharpFuzz.

### Enable unsafe code in Visual Studio

1. Right-click the project > Properties.
2. Go to the Build tab.
3. Check the **Allow unsafe code** option.

## Step 1: Create the Plugin Symbolic Link

Before starting, create a symbolic link pointing to the Unreal plugin directory generated by the server:

Open PowerShell as Administrator and run:
.\LinkPlugin.ps1 -ServerDir "G:\Server" -ClientUnrealProjectDir "G:\NetworkSample"
> **If script execution is restricted, temporarily allow it with:**
>
> ```powershell
> Set-ExecutionPolicy RemoteSigned -Scope Process
> ```

## Step 2: Build the Plugin in Unreal

1. Right-click the `.uproject` file of your Unreal project and select **"Generate Visual Studio project files"**.
2. Open the Unreal project in Visual Studio.
3. When opening, a message will appear asking to build the plugin. Accept to compile.
4. If any error occurs, build manually in Visual Studio by opening the `.sln` file and compiling the project.

## Development Commands

The project uses **pnpm** as the package manager. Here are the available commands:

### ðŸš€ **Development**
```bash
pnpm dev
```
- Starts the server in development mode with hot-reload
- Automatically restarts on file changes
- Warnings are not treated as errors

### ðŸ”¨ **Build Commands**
```bash
# Development build
pnpm build

# Production build (optimized)
pnpm build:release
```
  
## Code Generation

When running the server in debug mode, the system automatically generates the necessary package files and support components for server operation and Unreal integration.

- The Unreal client's Intermediate directory is cleaned.
- The client's Visual Studio project is regenerated.
- Unreal Engine generates the required headers.
- If Visual Studio or Unreal Editor are open, you may need to recompile or refresh the project.

## Development Status

The project is actively under development with multiple core systems being implemented simultaneously:

### ðŸ› ï¸ **Currently In Progress**
- **RPC System** - Automatic remote procedure call generation
- **C# Packet Creation** - Dynamic packet creation and serialization
- **Network Event System** - Event-driven network communication
- **Reliable Messaging** - Guaranteed delivery system with acknowledgments
- **Packet Queue System** - Per-connection fixed buffer transmission queuing
- **Fragment Reliability Policies** - Integration with reliable resend & congestion metrics

### âœ… **Completed**
- **Testing Framework** - Custom testing system with descriptive structure
- **Base36 Utilities** - Integer encoding/decoding with full test coverage
- **CRC32C Implementation** - Hardware-accelerated checksum computation with unsafe pointer support
- **LZ4 Compression** - Fast compression and decompression with byte pointer support
- **FlatBuffer System** - High-performance unsafe pointer-based binary serialization
- **NanoSockets Integration** - Low-level UDP socket operations with unsafe pointers
- **Buffer Management** - Zero-allocation buffer system using unsafe memory operations
- **Integrity System** - Key table store with simplified client-side access
- **Packet Reception Queue** - Efficient packet reception and processing system
- **X25519 Secure Handshake** - Hybrid implementation using BouncyCastle (C#) and libsodium (C++)
- **Packet Fragmentation** - Automatic fragmentation for packets > 1200 bytes with reassembly
- **FlatBuffer byte[] Support** - Native byte array serialization with customizable length
- **Contract System byte[] Fields** - Transpiler support for raw byte arrays
- **World Origin Rebasing System** - Quadrant-based position quantization with int16 compression
- **Unreal Plugin Integration** - Native Unreal Engine integration with Blueprint support
- **Base Entity Replication** - Complete entity synchronization system with quantized data

## System Architecture

### High-Performance Network Stack
Built on zero-allocation principles with unsafe pointer operations for maximum performance:

- **NanoSockets**: Low-level UDP operations with direct memory access
- **UDPServer/UDPSocket**: Enhanced connection management with per-connection fixed buffers
- **Packet Queue System**: Efficient reception and transmission queuing
- **FlatBuffer**: Unsafe pointer-based binary serialization with advanced features

### Security Layer
- **Complete End-to-End Encryption**: ChaCha20-Poly1305 AEAD for all payloads
- **Cookie Anti-Spoof**: HMAC-SHA256 stateless protection against DDoS amplification
- **Replay Protection**: 64-position sliding window with bitset optimization
- **SecureSession**: X25519 ECDH key exchange with HKDF key derivation
- **Dual Crypto Stack**: BouncyCastle (C#) and libsodium (C++) with identical security
- **Structured Headers**: 14-byte headers with connection ID, channel, flags, and sequence

### Game Systems
- **Entity Replication**: Complete synchronization system with quantized data compression
- **World Origin Rebasing**: Quadrant-based world division with int16 position quantization
- **Packet Fragmentation**: Automatic handling of large packets (>1200 bytes)
- **Integrity System**: CRC32C validation with hardware acceleration
- **Cross-Platform Support**: C# server with native Unreal Engine C++ client integration

### FlatBuffer Serialization System

Advanced binary serialization with unsafe pointer operations for maximum performance:

**Core Features:**
- **Zero-Allocation Operations**: Direct memory management without garbage collection overhead
- **Variable-Length Encoding**: ZigZag/VarInt compression (up to 75% size reduction)
- **Bit-Level Operations**: Efficient boolean and flag storage
- **Quantization System**: Float/Vector compression (50-75% bandwidth reduction)
- **World Origin Rebasing**: Position quantization to int16 with quadrant-based world division
- **String & Byte Array Support**: ASCII/UTF8 strings and raw binary data handling
- **Position Management**: Save/restore for complex serialization patterns
- **Blueprint Compatibility**: int32 properties with int16 network serialization

### World Origin Rebasing System

Advanced large-world support with bandwidth optimization:

**Core Features:**
- **Quadrant-Based Division**: Configurable world sectioning with automatic quadrant calculation
- **Position Quantization**: Float positions compressed to int16 for 60% bandwidth reduction  
- **Map-Specific Configuration**: Per-map settings for section size, components, and scale factors
- **Yaw-Only Rotation**: Optional rotation compression using only Yaw component
- **Blueprint Compatibility**: int32 properties with int16 network serialization for Unreal Engine
- **Automatic Coordinate Conversion**: Seamless world-to-quadrant-to-quantized position pipeline

**Technical Benefits:**
- **Bandwidth Optimization**: ~60% reduction in position data size per packet
- **Large World Support**: Virtually unlimited world sizes through quadrant system
- **Precision Control**: Configurable scale factors for application-specific precision needs
- **Cross-Platform**: C# server with native Unreal Engine C++ client integration
- **Zero-Allocation**: Efficient quantization/dequantization without memory overhead

### End-to-End Encryption System

Military-grade security implementation with zero-performance impact:

**Cryptographic Features:**
- **ChaCha20-Poly1305 IETF**: Industry-standard AEAD cipher with 128-bit authentication
- **X25519 Key Exchange**: Elliptic curve Diffie-Hellman with perfect forward secrecy
- **HKDF Key Derivation**: RFC 5869 compliant key derivation with separate TX/RX keys
- **Replay Protection**: 64-position sliding window prevents packet replay attacks
- **Cookie Anti-Spoof**: HMAC-SHA256 stateless protection against DDoS amplification

**Security Properties:**
- **Confidentiality**: All payloads encrypted with ChaCha20 stream cipher
- **Authenticity**: Poly1305 MAC ensures packet authenticity and integrity
- **Forward Secrecy**: Ephemeral X25519 keys provide forward secrecy
- **Replay Resistance**: Sequence-based nonces with sliding window validation
- **DDoS Protection**: Stateless cookie validation prevents amplification attacks

## Key Features

### âœ… **Core Systems**
- **High-performance UDP Server** with NanoSockets and zero-allocation packet processing
- **Complete End-to-End Encryption** with ChaCha20-Poly1305 AEAD and replay protection
- **Advanced FlatBuffer System** with unsafe pointer operations and comprehensive serialization
- **World Origin Rebasing System** with quadrant-based position quantization for large worlds
- **Entity Replication System** with quantized data compression and real-time synchronization
- **Native Unreal Engine Integration** with C++ client and Blueprint support
- **X25519 Secure Handshake** using BouncyCastle (C#) and libsodium (C++)
- **Cookie Anti-Spoof Protection** with HMAC-SHA256 stateless validation
- **Packet Fragmentation & Reassembly** for large packets with automatic cleanup
- **Hardware-Accelerated CRC32C** checksum with integrity validation
- **Custom Testing Framework** with comprehensive test coverage

### ðŸ› ï¸ **In Development**
- **Reliable Messaging System** with guaranteed delivery and acknowledgments
- **RPC System** with automatic remote procedure call generation

### â³ **Planned**
- **WebSocket Support** for web clients
- **Area of Interest (AOI)** for large-scale multiplayer optimization

## Development Roadmap

### âœ… **Completed Systems**
- **Network Infrastructure**: UDP server with NanoSockets, zero-allocation buffers, packet queuing
- **Complete Encryption**: ChaCha20-Poly1305 AEAD with replay protection and cookie anti-spoof
- **Security**: X25519 handshake, HKDF key derivation, BouncyCastle/libsodium integration  
- **Serialization**: FlatBuffer with unsafe pointers, ZigZag/VarInt encoding, quantization
- **World Origin Rebasing**: Quadrant-based world division with int16 position quantization
- **Game Systems**: Complete entity replication with quantized data compression and real-time sync
- **Unreal Integration**: Native C++ client with Blueprint support and automatic code generation
- **Utilities**: Base36 encoding, CRC32C checksums, LZ4 compression, testing framework
- **Fragmentation**: Automatic packet fragmentation/reassembly for packets > 1200 bytes

### ðŸ› ï¸ **In Progress**
- **Reliability**: Guaranteed message delivery with acknowledgments
- **RPC System**: Automatic remote procedure call generation

### â³ **Planned**
- **Authentication**: JWT token system
- **Optimization**: Area of Interest (AOI) for large-scale multiplayer
- **WebSocket**: Support for web clients
- **Physics**: Advanced physics state replication

## Scripts Reference

| Command | Description | Use Case |
|---------|-------------|----------|
| `pnpm dev` | Development server with hot-reload | Daily development |
| `pnpm build` | Development build | Testing builds |
| `pnpm build:release` | Production build (optimized) | Pre-deployment testing |
| `pnpm publish` | Generate distributable executable | Production deployment |

> **Note:** All commands use the .NET CLI under the hood and are configured for optimal performance and development experience.
