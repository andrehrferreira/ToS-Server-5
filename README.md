# Tales Of Shadowland MMO Server 5

This is a multiplayer server based on .NET 8, which automatically generates RPC communication packages and .cpp files for use with Unreal Engine, supporting both C++ and Blueprints. Follow the steps below to set up and start the project.

## Prerequisites

- **Windows 10 or higher**
- **Unreal Engine 5.5+ (recommended)**
- **.NET SDK 8.0 or higher**
- **Visual Studio 2022** 
- Windows **Developer Mode** (to create symlinks)

**Dependencies:** All NuGet packages are automatically installed via `dotnet restore` including Newtonsoft.Json, Spectre.Console, BouncyCastle.Cryptography, FsCheck, and SharpFuzz.

### Enable unsafe code in Visual Studio

1. Right-click the project > Properties.
2. Go to the Build tab.
3. Check the **Allow unsafe code** option.

## Step 1: Create the Plugin Symbolic Link

Before starting, create a symbolic link pointing to the Unreal plugin directory generated by the server:

Open PowerShell as Administrator and run:
.\LinkPlugin.ps1 -ServerDir "G:\Server" -ClientUnrealProjectDir "G:\NetworkSample"
> **If script execution is restricted, temporarily allow it with:**
>
> ```powershell
> Set-ExecutionPolicy RemoteSigned -Scope Process
> ```

## Step 2: Build the Plugin in Unreal

1. Right-click the `.uproject` file of your Unreal project and select **"Generate Visual Studio project files"**.
2. Open the Unreal project in Visual Studio.
3. When opening, a message will appear asking to build the plugin. Accept to compile.
4. If any error occurs, build manually in Visual Studio by opening the `.sln` file and compiling the project.

## Development Commands

The project uses **pnpm** as the package manager. Here are the available commands:

### 🚀 **Development**
```bash
pnpm dev
```
- Starts the server in development mode with hot-reload
- Automatically restarts on file changes
- Warnings are not treated as errors

### 🔨 **Build Commands**
```bash
# Development build
pnpm build

# Production build (optimized)
pnpm build:release
```
  
## Code Generation

When running the server in debug mode, the system automatically generates the necessary package files and support components for server operation and Unreal integration.

- The Unreal client's Intermediate directory is cleaned.
- The client's Visual Studio project is regenerated.
- Unreal Engine generates the required headers.
- If Visual Studio or Unreal Editor are open, you may need to recompile or refresh the project.

## Development Status

The project is actively under development with multiple core systems being implemented simultaneously:

### 🛠️ **Currently In Progress**
- **RPC System** - Automatic remote procedure call generation
- **C# Packet Creation** - Dynamic packet creation and serialization
- **Unreal Plugin** - Native Unreal Engine integration
- **Base Replication** - Entity synchronization system
- **Full Payload Encryption** - Applying AEAD to reliable/unreliable channels
- **Network Event System** - Event-driven network communication
- **Reliable Messaging** - Guaranteed delivery system with acknowledgments
- **Packet Queue System** - Per-connection fixed buffer transmission queuing
- **Fragment Reliability Policies** - Integration with reliable resend & congestion metrics

### ✅ **Completed**
- **Testing Framework** - Custom testing system with descriptive structure
- **Base36 Utilities** - Integer encoding/decoding with full test coverage
- **CRC32C Implementation** - Hardware-accelerated checksum computation with unsafe pointer support
- **LZ4 Compression** - Fast compression and decompression with byte pointer support
- **FlatBuffer System** - High-performance unsafe pointer-based binary serialization
- **NanoSockets Integration** - Low-level UDP socket operations with unsafe pointers
- **Buffer Management** - Zero-allocation buffer system using unsafe memory operations
- **Integrity System** - Key table store with simplified client-side access
- **Packet Reception Queue** - Efficient packet reception and processing system
- **X25519 Secure Handshake** - Hybrid implementation using BouncyCastle (C#) and libsodium (C++)
- **Packet Fragmentation** - Automatic fragmentation for packets > 1200 bytes with reassembly
- **FlatBuffer byte[] Support** - Native byte array serialization with customizable length
- **Contract System byte[] Fields** - Transpiler support for raw byte arrays

## System Architecture

### High-Performance Network Stack
Built on zero-allocation principles with unsafe pointer operations for maximum performance:

- **NanoSockets**: Low-level UDP operations with direct memory access
- **UDPServer/UDPSocket**: Enhanced connection management with per-connection fixed buffers
- **Packet Queue System**: Efficient reception and transmission queuing
- **FlatBuffer**: Unsafe pointer-based binary serialization with advanced features

### Security Layer
- **SecureSession**: X25519 ECDH key exchange with HKDF key derivation
- **BouncyCastle** (C#): Cryptographic operations and key management
- **libsodium** (C++): Unreal Engine cryptographic integration
- **ChaCha20-Poly1305**: AEAD encryption for secure communication

### Game Systems
- **Entity Replication**: Delta compression with real-time synchronization
- **Packet Fragmentation**: Automatic handling of large packets (>1200 bytes)
- **Integrity System**: CRC32C validation with hardware acceleration

### FlatBuffer Serialization System

Advanced binary serialization with unsafe pointer operations for maximum performance:

**Core Features:**
- **Zero-Allocation Operations**: Direct memory management without garbage collection overhead
- **Variable-Length Encoding**: ZigZag/VarInt compression (up to 75% size reduction)
- **Bit-Level Operations**: Efficient boolean and flag storage
- **Quantization System**: Float/Vector compression (50-75% bandwidth reduction)
- **String & Byte Array Support**: ASCII/UTF8 strings and raw binary data handling
- **Position Management**: Save/restore for complex serialization patterns

## Key Features

### ✅ **Core Systems**
- **High-performance UDP Server** with NanoSockets and zero-allocation packet processing
- **Automatic RPC Generation** with C# packet creation and Unreal Engine integration
- **Advanced FlatBuffer System** with unsafe pointer operations and comprehensive serialization
- **Entity Replication System** with delta compression and real-time synchronization
- **X25519 Secure Handshake** using BouncyCastle (C#) and libsodium (C++)
- **Packet Fragmentation & Reassembly** for large packets with automatic cleanup
- **Hardware-Accelerated CRC32C** checksum with integrity validation
- **Custom Testing Framework** with comprehensive test coverage

### 🛠️ **In Development**
- **Full Payload Encryption** with ChaCha20-Poly1305 AEAD
- **Reliable Messaging System** with guaranteed delivery and acknowledgments
- **Unreal Engine Plugin** with native C++ and Blueprint support

### ⏳ **Planned**
- **WebSocket Support** for web clients
- **Area of Interest (AOI)** for large-scale multiplayer optimization

## Development Roadmap

### ✅ **Completed Systems**
- **Network Infrastructure**: UDP server with NanoSockets, zero-allocation buffers, packet queuing
- **Security**: X25519 handshake, HKDF key derivation, BouncyCastle/libsodium integration  
- **Serialization**: FlatBuffer with unsafe pointers, ZigZag/VarInt encoding, quantization
- **Game Systems**: Entity replication with delta compression, real-time synchronization
- **Utilities**: Base36 encoding, CRC32C checksums, LZ4 compression, testing framework
- **Fragmentation**: Automatic packet fragmentation/reassembly for packets > 1200 bytes

### 🛠️ **In Progress**
- **Encryption**: ChaCha20-Poly1305 AEAD for payload encryption
- **Reliability**: Guaranteed message delivery with acknowledgments
- **RPC System**: Automatic remote procedure call generation
- **Unreal Plugin**: Native C++ integration with Blueprint support

### ⏳ **Planned**
- **Authentication**: JWT token system
- **Optimization**: Area of Interest (AOI) for large-scale multiplayer
- **WebSocket**: Support for web clients
- **Physics**: Advanced physics state replication

## Scripts Reference

| Command | Description | Use Case |
|---------|-------------|----------|
| `pnpm dev` | Development server with hot-reload | Daily development |
| `pnpm build` | Development build | Testing builds |
| `pnpm build:release` | Production build (optimized) | Pre-deployment testing |
| `pnpm publish` | Generate distributable executable | Production deployment |

> **Note:** All commands use the .NET CLI under the hood and are configured for optimal performance and development experience.
