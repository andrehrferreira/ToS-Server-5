# Tales Of Shadowland MMO Server 5

This is a multiplayer server based on .NET 8, which automatically generates RPC communication packages and .cpp files for use with Unreal Engine, supporting both C++ and Blueprints. Follow the steps below to set up and start the project.

## Prerequisites

- **Windows 10 or higher**
- **Unreal Engine 5.0 or higher**
- **.NET SDK 8.0 or higher**
- **Visual Studio 2022** 

Before setting up the project, make sure to install the following NuGet packages:

1. **DotNetEnv**  
    [Download DotNetEnv](https://www.nuget.org/packages/DotNetEnv)
2. **Microsoft.VisualStudio.Interop**  
    [Download Microsoft.VisualStudio.Interop](https://www.nuget.org/packages/Microsoft.VisualStudio.Interop)
3. **System.Reactive**  
    [Download System.Reactive](https://www.nuget.org/packages/System.Reactive)
4. **Newtonsoft.Json**
    [Download Newtonsoft.Json](https://www.nuget.org/packages/Newtonsoft.Json)

### Enable unsafe code in Visual Studio

1. Right-click the project > Properties.
2. Go to the Build tab.
3. Check the **Allow unsafe code** option.

## Step 1: Create the Plugin Symbolic Link

Before starting, create a symbolic link pointing to the Unreal plugin directory generated by the server:

Open PowerShell as Administrator and run:
.\LinkPlugin.ps1 -ServerDir "G:\Server" -ClientUnrealProjectDir "G:\NetworkSample"
> **If script execution is restricted, temporarily allow it with:**
>
> ```powershell
> Set-ExecutionPolicy RemoteSigned -Scope Process
> ```

## Step 2: Build the Plugin in Unreal

1. Right-click the `.uproject` file of your Unreal project and select **"Generate Visual Studio project files"**.
2. Open the Unreal project in Visual Studio.
3. When opening, a message will appear asking to build the plugin. Accept to compile.
4. If any error occurs, build manually in Visual Studio by opening the `.sln` file and compiling the project.

## Development Commands

The project uses **pnpm** as the package manager. Here are the available commands:

### 🚀 **Development**
```bash
pnpm dev
```
- Starts the server in development mode with hot-reload
- Automatically restarts on file changes
- Warnings are not treated as errors

### 🔨 **Build Commands**
```bash
# Development build
pnpm build

# Production build (optimized)
pnpm build:release
```
  
## Code Generation

When running the server in debug mode, the system automatically generates the necessary package files and support components for server operation and Unreal integration.

- The Unreal client's Intermediate directory is cleaned.
- The client's Visual Studio project is regenerated.
- Unreal Engine generates the required headers.
- If Visual Studio or Unreal Editor are open, you may need to recompile or refresh the project.

## Development Status

The project is actively under development with multiple core systems being implemented simultaneously:

### 🛠️ **Currently In Progress**
- **RPC System** - Automatic remote procedure call generation
- **C# Packet Creation** - Dynamic packet creation and serialization
- **Unreal Plugin** - Native Unreal Engine integration
- **Base Replication** - Entity synchronization system
- **Network Event System** - Event-driven network communication
- **Reliable Messaging** - Guaranteed delivery system with acknowledgments
- **Packet Queue System** - Per-connection fixed buffer transmission queuing

### ✅ **Completed**
- **Testing Framework** - Custom testing system with descriptive structure
- **Base36 Utilities** - Integer encoding/decoding with full test coverage
- **CRC32C Implementation** - Hardware-accelerated checksum computation with unsafe pointer support
- **FlatBuffer System** - High-performance unsafe pointer-based binary serialization
- **NanoSockets Integration** - Low-level UDP socket operations with unsafe pointers
- **Buffer Management** - Zero-allocation buffer system using unsafe memory operations
- **Integrity System** - Key table store with simplified client-side access
- **Packet Reception Queue** - Efficient packet reception and processing system

## UDP Server Architecture

The UDP server has been completely redesigned for maximum performance using unsafe pointers and zero-allocation principles:

### Core Components
- **UDPServer**: Main server class with NanoSockets integration and unsafe operations
- **UDPSocket**: Enhanced socket wrapper with fixed transmission buffers per connection
- **FlatBuffer**: High-performance unsafe pointer-based binary serialization (replaces ByteBuffer)
- **NanoSockets**: Low-level UDP operations using unsafe pointers for maximum performance
- **Packet Queue System**: Per-connection fixed buffers for efficient packet transmission
- **IntegrityKeyTableStore**: Version-based key table management with simplified client access

### FlatBuffer System - Advanced Features

The FlatBuffer system provides a comprehensive set of high-performance serialization features:

#### Core Operations
- **Unsafe Pointer Management**: Direct `byte*` operations with `Marshal.AllocHGlobal/FreeHGlobal`
- **Template Operations**: Generic `Read<T>()` and `Write<T>()` for all unmanaged types
- **Zero-Allocation**: No managed memory allocations during serialization/deserialization
- **Position Management**: `SavePosition()` and `RestorePosition()` for complex serialization patterns
- **Peek Operations**: Non-destructive `Peek<T>()` for data inspection without advancing position

#### Variable-Length Encoding
- **ZigZag Encoding**: Efficient signed integer compression using ZigZag encoding/decoding
- **VarInt Support**: Variable-length integer encoding for `int`, `uint`, `long`, `ulong`
- **Space Optimization**: Reduces packet size by up to 75% for small integer values
- **Overflow Protection**: Built-in overflow detection for corrupted data handling

#### Bit-Level Operations
- **Bit Manipulation**: `WriteBit()` and `ReadBit()` for boolean and flag serialization
- **Bit Alignment**: `AlignBits()` for proper byte boundary alignment
- **Compact Storage**: Efficient boolean array storage with bit-level precision
- **Mixed Mode**: Seamless transition between bit and byte operations

#### Quantization System
- **Float Quantization**: `WriteQuantized()` and `ReadQuantizedFloat()` for compressed float values
- **FVector Quantization**: 3D vector compression with configurable min/max ranges
- **FRotator Quantization**: Rotation compression for Unreal Engine integration
- **Precision Control**: Configurable quantization ranges for optimal space/precision trade-offs

#### String Operations
- **ASCII Support**: `WriteAsciiString()` and `ReadAsciiString()` for basic text
- **UTF8 Support**: `WriteUtf8String()` and `ReadUtf8String()` for internationalization
- **Length Prefixing**: Automatic length encoding for safe string deserialization
- **Memory Safety**: Bounds checking and buffer overflow prevention

#### Data Integrity
- **Hash Generation**: `GetHashFast()` for quick data integrity checks
- **Hex Conversion**: `ToHex()` for debugging and data inspection
- **Bounds Checking**: Automatic buffer overflow prevention
- **Exception Safety**: Graceful handling of malformed data

#### Memory Management
- **Manual Control**: Direct memory allocation and deallocation control
- **Dispose Pattern**: Proper `IDisposable` implementation for resource cleanup
- **Buffer Reuse**: Reset functionality for buffer reuse without reallocation
- **Capacity Management**: Dynamic capacity tracking and overflow prevention

### Performance Optimizations
- **Zero Allocation**: Unsafe pointer operations eliminate memory allocations
- **Fixed Buffers**: Per-connection transmission buffers reduce memory fragmentation
- **Direct Memory Access**: NanoSockets provides direct memory operations
- **Packet Queuing**: Efficient reception and transmission packet queuing
- **Hardware Acceleration**: CRC32C with SSE4.2 and ARM Crypto support
- **Bit-Level Efficiency**: Optimal space utilization with bit-level operations
- **Quantization Compression**: Significant bandwidth reduction for floating-point data

### Network Features
- **Connection Management**: NanoSockets-based UDP client connection handling ✅
- **Buffer Management**: Zero-allocation unsafe pointer buffer system ✅
- **Packet Serialization**: FlatBuffer unsafe pointer-based serialization ✅
- **Integrity System**: Version-based key table management ✅
- **Reception Queue**: Efficient packet reception queuing system ✅
- **Transmission Queue**: Per-connection fixed buffer transmission system ✅
- **Reliable Messaging**: Guaranteed delivery with acknowledgment system 🛠️
- **Packet Validation**: Integrity checking and validation ⏳
- **Encryption**: Secure packet transmission ⏳
- **Heartbeat System**: Client connectivity monitoring ⏳

## Features

- **Automatic RPC generation** (in development)
- **Unreal Engine plugin integration** (in development)
- **High-performance UDP server with NanoSockets** ✅
- **Zero-allocation packet processing** ✅
- **C# packet creation system** (in development)
- **Entity replication system** (in development)
- **Network event system** (in development)
- **WebSocket support** (planned)
- **Automated testing framework** ✅
- **High-performance binary communication with FlatBuffer** ✅
- **Unsafe pointer-based buffer management** ✅
- **XOR encoding and ECC/AES encryption** (planned)
- **Base36 encoding/decoding utilities** ✅
- **Hardware-accelerated CRC32C checksum** ✅
- **Integrity key table system** ✅

### FlatBuffer Advanced Features ✅
- **ZigZag Encoding**: Efficient signed integer compression (30-50% size reduction)
- **Variable-Length Integers**: VarInt/VarLong encoding (up to 75% size reduction for small values)
- **Bit-Level Operations**: Boolean and flag storage with single-bit precision
- **Quantization System**: Float/FVector/FRotator compression (50-75% bandwidth reduction)
- **String Operations**: ASCII and UTF8 string handling with length prefixing
- **Template Operations**: Generic read/write operations with compile-time optimization
- **Position Management**: Save/restore positions for complex serialization patterns
- **Data Integrity**: Fast hash generation and hex conversion for debugging
- **Memory Management**: Direct unsafe pointer control with proper disposal patterns

## Changelog

### Version 5.1.0 - Network Performance Overhaul (Current)

#### 🚀 **Major Performance Improvements**
- **Replaced ByteBuffer with FlatBuffer**: Implemented a simplified, optimized unsafe pointer-based serialization system
- **NanoSockets Integration**: Complete migration from System.Net.Sockets to NanoSockets for maximum performance
- **Zero-Allocation Architecture**: Eliminated memory allocations in packet processing using unsafe pointers
- **Direct Memory Operations**: All buffer operations now use direct memory access via `byte*` pointers

#### 🔄 **Buffer System Redesign**
- **Fixed Connection Buffers**: Each connection now has dedicated fixed-size transmission buffers
- **Packet Reception Queue**: Implemented efficient packet reception queuing system
- **Transmission Queue Optimization**: Per-connection transmission queuing with fixed buffer allocation
- **Memory Management**: Transitioned from ArrayPool to manual unsafe memory management

#### ⚡ **Performance Optimizations**
- **Unsafe Pointer Operations**: All critical paths now use unsafe `byte*` operations
- **Hardware-Accelerated CRC32C**: Added unsafe pointer support to CRC32C with SSE4.2/ARM optimization
- **Reduced Packet Limits**: Optimized packet processing limits from 2000 to 1000 per cycle for better throughput
- **Direct Socket Operations**: Eliminated intermediate buffers using NanoSockets.UDP.Unsafe methods

#### 🔧 **System Architecture Changes**
- **SendPacket Structure**: Updated to use `byte*` instead of `byte[]` for zero-allocation sending
- **Connection Management**: Enhanced with NanoSockets.Address instead of EndPoint
- **Event-Driven Processing**: Added per-connection event queues for packet processing
- **Benchmark Integration**: Simplified benchmark packet handling with direct event queuing

#### 🛠️ **Infrastructure Updates**
- **WAF Rate Limiter**: Updated to work with NanoSockets.Address
- **Batch Operations**: Redesigned UdpBatchIO for unsafe pointer operations
- **Testing Framework**: Enhanced testing support for new buffer systems
- **Public Metrics**: Exposed connection and performance metrics for monitoring

#### 📈 **Status Updates**
- **Reliable Messaging**: Now in active development with acknowledgment system
- **Packet Validation**: Moved to planned status for next phase
- **Buffer Pooling**: Replaced with direct unsafe memory management

### Previous Versions
- **Version 5.0.0**: Initial release with basic UDP server and ByteBuffer system
- **Version 4.x**: Legacy versions with different architecture

## Checklist

### Core Utilities
| Feature                             | Status            | Notes                                                       |
|------------------------------------|-------------------|-------------------------------------------------------------|
| Base36 Encoding/Decoding           | ✅ Implemented     | Base36 utility for encoding/decoding integers with tests.  |
| CRC32C Checksum                    | ✅ Implemented     | Hardware-accelerated CRC32C with unsafe pointer support.   |
| Testing Framework                  | ✅ Implemented     | Custom testing framework with descriptive test structure.   |
| Integrity Key Table Store          | ✅ Implemented     | Version-based key table management with simple client access. |

### Network & Communication
| Feature                             | Status            | Notes                                                       |
|------------------------------------|-------------------|-------------------------------------------------------------|
| RPC                                | 🛠 In Progress     | RPC system in development.                                  |
| C# Packet Creation                 | 🛠 In Progress     | C# packet creation system in development.                   |
| Unreal Plugin                      | 🛠 In Progress     | Unreal Engine plugin development in progress.               |
| WebSocket                          | ⏳ Not Implemented | WebSocket support not implemented yet.                      |
| XOR Encoding                       | ⏳ Not Implemented | XOR encoding system not implemented yet.                    |
| ECC and AES256 Encryption          | ⏳ Not Implemented | ECC/AES256 encryption not implemented yet.                  |

#### UDP Server Implementation
| Feature                             | Status            | Notes                                                       |
|------------------------------------|-------------------|-------------------------------------------------------------|
| NanoSockets Integration            | ✅ Implemented     | Complete migration to NanoSockets for maximum performance. |
| Basic Connection                   | ✅ Implemented     | Enhanced UDP connection with NanoSockets.Address support.  |
| FlatBuffer System                  | ✅ Implemented     | Unsafe pointer-based binary serialization system.         |
| Zero-Allocation Buffers            | ✅ Implemented     | Direct memory management without allocations or pooling.   |
| Packet Reception Queue             | ✅ Implemented     | Efficient packet reception and processing queuing.         |
| Per-Connection Buffers             | ✅ Implemented     | Fixed transmission buffers for each connection.            |
| Integrity Key Table Store          | ✅ Implemented     | Version-based key management with simple client-side access. |
| Reliable Messaging                 | 🛠 In Progress     | Guaranteed delivery system with acknowledgments in development. |
| Packet Validation                  | ⏳ Planned         | Packet integrity and validation system to be implemented.  |
| Packet Encryption                  | ⏳ Planned         | Packet encryption system to be implemented.                |
| Client Heartbeat                   | ⏳ Planned         | Client validation heartbeat system to be implemented.      |

##### FlatBuffer Advanced Features
| Feature                             | Status            | Notes                                                       |
|------------------------------------|-------------------|-------------------------------------------------------------|
| ZigZag Encoding                    | ✅ Implemented     | Efficient signed integer compression (30-50% size reduction). |
| Variable-Length Integers           | ✅ Implemented     | VarInt/VarLong encoding (up to 75% size reduction for small values). |
| Bit-Level Operations               | ✅ Implemented     | Boolean and flag storage with single-bit precision.        |
| Quantization System                | ✅ Implemented     | Float/FVector/FRotator compression (50-75% bandwidth reduction). |
| String Operations                  | ✅ Implemented     | ASCII and UTF8 string handling with length prefixing.      |
| Template Operations                | ✅ Implemented     | Generic read/write operations with compile-time optimization. |
| Position Management                | ✅ Implemented     | Save/restore positions for complex serialization patterns. |
| Data Integrity                     | ✅ Implemented     | Fast hash generation and hex conversion for debugging.     |
| Memory Management                  | ✅ Implemented     | Direct unsafe pointer control with proper disposal patterns. |

### Game Systems
| Feature                             | Status            | Notes                                                       |
|------------------------------------|-------------------|-------------------------------------------------------------|
| Base Replication                   | 🛠 In Progress     | Base element replication system in development.             |
| Network Event System               | 🛠 In Progress     | Per-connection event queuing system implemented.            |
| JWT Authentication                 | ⏳ Not Implemented | JWT authentication not implemented yet.                     |
| Reactive System                    | ⏳ Not Implemented | Reactive system not implemented yet.                        |
| Reactive Request Handlers          | ⏳ Not Implemented | Reactive request handlers not implemented yet.              |

## Scripts Reference

| Command | Description | Use Case |
|---------|-------------|----------|
| `pnpm dev` | Development server with hot-reload | Daily development |
| `pnpm build` | Development build | Testing builds |
| `pnpm build:release` | Production build (optimized) | Pre-deployment testing |
| `pnpm publish` | Generate distributable executable | Production deployment |

> **Note:** All commands use the .NET CLI under the hood and are configured for optimal performance and development experience.
